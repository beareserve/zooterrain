<!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->
<html>
<head>
    <title>ZooTerrain</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        html, body {
          background-color: #eee;
        }
        body {
          padding-top: 40px;
        }
        .container > footer p {
          text-align: center;
        }
        .container {
          width: 820px;  
        }
  
        .content {
          background-color: #fff;
          padding: 20px;
          margin: 0 -20px; 
          -webkit-border-radius: 0 0 6px 6px;
             -moz-border-radius: 0 0 6px 6px;
                  border-radius: 0 0 6px 6px;
          -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.15);
             -moz-box-shadow: 0 1px 2px rgba(0,0,0,.15);
                  box-shadow: 0 1px 2px rgba(0,0,0,.15);
        }
        
        .cont_tree {
        }
        .cont_tree > tbody > tr > td {
            font-size: 12px;
            padding: 6px;
        }

        .node_path {
            font-family: "Courier New";
        }
        .node_no {
            margins:auto;
        }
    </style>
</head>
<body>
<script type="text/javascript">
    var socket;
    if (!window.WebSocket) {
        window.WebSocket = window.MozWebSocket;
    }
    if (window.WebSocket) {
        socket = new WebSocket("${wsLoc}");
        socket.onmessage = received;
        socket.onopen = function (event) {
            $("#status").html("<span class='label label-success'><span class='glyphicon glyphicon-ok'></span></span>")
            send("{\"r\":\"i\"");
        };
        socket.onclose = function (event) {
            $("#status").html("<span class='label label-danger'><span class='glyphicon glyphicon-flash'></span></span>")
        };
    } else {
        alert("Your browser does not support Web Socket.");
    }

    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
        } else {
            alert("The socket is not open.");
        }
    }

    function received(event) {
        var evenData = event.data;
        try {
            var msg = JSON.parse(evenData);
        } catch (e) {
            evenData = "Error parsing " + evenData;
            return;
        }
        
        var ta = $("#responseLog");
        ta.html(evenData + '\n' + ta.html());

        var msgType = msg.type;
        
        if (msgType === "U" || msgType === "C" || msgType === "D") {
            handle_znodeEvent(msg);
        } else {
            handle_controlEvent(msg);
        }
    }
    
    function handle_controlEvent(msg) {
        if (msg.type === "H") {
            $("#conn").html(msg.msg);
        }
    }
    
    function handle_znodeEvent(msg) {
        try {
            $("#tree_empty_default").remove();
            var optype = msg.type;
            var znode = msg.znode;
            var znode_us = znode.replace(/\//g, "-");
            var elContZnode = "cont_" + znode_us; 
            var elInfoZnode = "info_" + znode_us; 

            if (optype === "D") {
                if ($("#" + elContZnode).length != 0) {
                    var remove_node = function() {
                        var nodeCont = $("#" + elContZnode);
                        nodeCont.stop();
                        nodeCont.css({backgroundColor:'#e00000'});
                        nodeCont.animate({backgroundColor:'grey', color:'grey'},8*1000, 
                                function() {
                                    nodeCont.slideUp(250);
                                    nodeCont.delay(250);
                                    nodeCont.remove();
                                }
                        );
                    };
                    remove_node();
                }
                return;
            }
            // remaining optypes: "U" ||Â "C"
            
            var infoHtml = "";
            infoHtml += "<td><span></span></td>";
            infoHtml += "<td id='" + elInfoZnode + "'>" +
                    "<span class='label " + (msg.eph ? "label-warning" : "label-primary") + "'>" 
                    + (msg.eph ? "eph" : "per") + 
                    "</span> <span class='node_path'>" + znode + "</span></td>";
            infoHtml += "<td align='center'>" + msg.dl + "</td>";
            infoHtml += "<td align='center'>" + msg.dv + "</td>";
            //infoHtml += "<td align='center'>" + new Date(msg.ct) + "</td>";
            
            var isNew = optype === "C";
            var append_to = function () {
                $(infoHtml).hide().appendTo(("#" + elContZnode)).slideDown(isNew ? 250 : 0).fadeIn(isNew ? 1000 : 0);
                if (isNew) {
                    $("#" + elContZnode).css({backgroundColor:'#00ff00'});
                    $("#" + elContZnode).animate({backgroundColor:'grey'},60*1000);
                }
            };
            
            if ($("#" + elContZnode).length == 0) {
                var contHtml = "<tr id='" + elContZnode + "'></tr>";
                if ($("#zktreebdy").children().length == 0) {
                    // insert first and only child
                    $("#zktreebdy").html(contHtml);
                    append_to();
                } else {
                    $("#zktreebdy").children().each(function(i) {
                        // insert before
                        var elId = $(this).attr('id');
                        if (elId > elContZnode) {
                            $(this).before(contHtml);
                            append_to();
                            return false;
                        }
                    });
                    if ($("#" + elContZnode).length == 0) {
                        // insert as very last
                        $("#zktreebdy").append(contHtml);
                        append_to();
                    }
                }                
            } else {
                $("#" + elContZnode).html(infoHtml).animate({backgroundColor:'#00ff00'},100).animate({backgroundColor:'grey'},100);
            }
            
        } catch (e) {
            alert("error displaying znode: " + e);
        }
    }
    
    function update_filter() {
        var searchExpression = $("#searchexpr").val();
        if (searchExpression.length  < 1) {
            $("#zktreebdy").children().show();
            return true;
        }
        $("#zktreebdy").children().each(function(i) {
            var nodePath = $(this).find(".node_path").text();
            if (!nodePath) return true;
            var match = false;
            try {
                match = nodePath.toLowerCase().indexOf(searchExpression.toLowerCase()) > -1;
            } catch (e) {
                return true;
            }
            
            if (match) {
                $(this).show();
            } else {
                $(this).hide();
            }
            return true;
        });
        return true;
    }
    
</script>

<div class="container">
    <div class="content">
      <div class="page-header">
        <h1>ZooTerrain <small>Insights into running ZooKeeper clusters</small></h1>
      </div>
      <div class="row">
        <div class="span10">
            <div class="well">
                ZK Connection <span id="conn"></span>  
                <span id="status">
                    <span class='label label-default'><span class='glyphicon glyphicon-road'></span></span>
                </span>
            </div>

            <div>
                <div class="input-group">
                    <input id="searchexpr" type="text" class="form-control" placeholder="filter expression" onkeyup="update_filter();">
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="button">Filter</button>
                  </span>
                </div>
            </div>

            <table id="zktree" class="table table-hover cont_tree">
                <thead><td>&nbsp;</td><td>znode</td><td>data length</td><td>data version</td></thead>
                <tbody id="zktreebdy">
                    <tr id="tree_empty_default"><td>No znode entries.</td></tr>
                </tbody>
            </table>
            <div style="display: none">
                <h5>Incoming Message Log</h5>
                <textarea id="responseLog" style="width:500px;height:300px; font-size: 10px"></textarea>
            </div>
        </div>
      </div>
    </div>
    <footer>
      <p>&copy; brainlounge 2014</p>
    </footer>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
</body>
</html>

